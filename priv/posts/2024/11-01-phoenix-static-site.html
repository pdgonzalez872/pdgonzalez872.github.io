<div hidden id=id>phoenix-static-site</div>
<div hidden id=title>Phoenix + Tailwind + Github Pages</div>
<div hidden id=author>Paulo Gonzalez</div>
<div hidden id=tags>elixir, phoenix, tailwind, github-pages, gambiarra</div>

<div class="text-2xl font-bold mt-6 mb-6">
  Using Phoenix and Tailwind to create static websites (my blog) on Github Pages
</div>

First off, there are many tools out there that give you a good experience to create static blogs leveraging Github Pages.

There are existing tools to do this, but I thought it would be a cool exercise to go from bottom up with this problem.

Half of my family is from Brazil and I am proud of my heritage. "Gambiarra" is a word in Portuguese (I would love for the language to be called Brazilian, but that's a different discussion altogether :) ) that comes up a lot in Brazilian culture. "Alternative Engineering" is my favorite synonym for it, but "McGyverism" is another good one. This Phoenix to static exercise qualifies as gambiarra in my books :)

First, we need to check Github Pages and learn how it works. Turns out that if you configure a public repository, Github publishes html to a domain (your handle, in my case @pdgonzalez872


More details here:
https://docs.github.com/en/pages/getting-started-with-github-pages/creating-a-github-pages-site

Then, this is the important piece:

> Create the entry file for your site. GitHub Pages will look for an index.html, index.md, or README.md file as the entry file for your site.

> If your publishing source is a branch and folder, the entry file must be at the top level of the source folder on the source branch. For example, if your publishing source is the /docs folder on the main branch, your entry file must be located in the /docs folder on a branch called main.

Here is the link to the above: https://docs.github.com/en/pages/getting-started-with-github-pages/creating-a-github-pages-site#creating-your-site

I did configure the repo to use the `/docs` option.

My previous setup used the root level index.html page, this time I went with `/docs` as I didn't want to have a bunch of files in the root dir, but other than that, no preference.

So the idea was "populate" a "/docs" folder with html files and files that are used by the html files (styling, images, js). That was the

I also wanted to use NimblePublisher, in fact, that was the original rabbit hole that got me here. I liked the idea of writing static content, then realized markdown was the default. But, adjusting the parser to use Floki was not too difficult.

In fact, that was my original starting point.

To dev locally and see differences in the html, I run `mix phx.server`

I created a couple of convenience scripts to help deploy and build (generate) the files as well as one to check on the "generated" files.


# build.sh
#!/bin/bash

echo "Start building"
MIX_ENV=prod PHX_HOST=localhost mix assets.deploy && MIX_ENV=prod PHX_HOST=localhost SECRET_KEY_BASE=hi mix build_static

echo "Kill docs dir"
rm -rf docs

echo "Move new dir to docs"
mv build docs

echo "Finish building"

# server.exs
# Usage:
# $ elixir server.exs
# and then visit: http://localhost:4001/index.html

Mix.install([
  {:plug, "~> 1.14"},
  {:bandit, "~> 1.5.7"}
])

defmodule SimpleServer do
  use Plug.Router

  plug Plug.Static,
    at: "/",
    from: "docs",
    gzip: true,
    cache_control_for_etags: "public, max-age=86400"

  plug :match
  plug :dispatch

  match _ do
    send_resp(conn, 404, "File not found")
  end
end

# Start the Bandit server
{:ok, _} = Bandit.start_link(plug: SimpleServer, port: 4001)
IO.puts("Server running")
Process.sleep(:infinity)

I had to adjust the .gitignore quite a bit, there is likely stuff committed to "/docs" that didn't need to be, but that's for a different sprint.

Moving the old posts to the new format was a bit annoying, but by the end of it I had a `translate.sh` script that helped get much closer.

When editing the html files, I quickly realized that the paths for using
Phoenix and the static html were different. It took a bit of time to figure out
why my Tailwind wouldn't work in the `/docs` folder (and in production), but in
the end, I wrote this Plug that helped set things as expected. Best of both
worlds.

Here is the Plug:

```elixir
defmodule PgBlogWeb.LinksPlug do
  @behaviour Plug

  import Plug.Conn

  def init(opts) do
    opts
  end

  def call(conn, _opts) do
    links =
      if System.get_env("MIX_ENV") == "prod" do
        %{
          app_css_link: "assets/app.css",
          home_link: "/index.html"
        }
      else
        %{
          app_css_link: "/assets/app.css",
          home_link: "/"
        }
      end

    conn
    |> assign(:app_css_link, links[:app_css_link])
    |> assign(:home_link, links[:home_link])
  end
end
```

Here is the mix task that does the magic:

There are likely 10 better ways to do this with Phoenix, but this is a valid one :)
